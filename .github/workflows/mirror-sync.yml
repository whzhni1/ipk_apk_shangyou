name: åŒæ­¥åˆ°é•œåƒä»“åº“

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["åŒæ­¥ä¸Šæ¸¸å‘å¸ƒç‰ˆæœ¬"]
    types:
      - completed
  schedule:
    - cron: '30 19 * * *'  # åŒ—äº¬æ—¶é—´ 3:30 AM = UTC 19:30 (åœ¨ä¸»åŒæ­¥åŽ30åˆ†é’Ÿ)

env:
  BRANCH: main
  USERNAME: whzhni1
  REPO: ipk_apk
  SOURCE_REPO: whzhni1/ipk_apk  # æºä»“åº“

jobs:
  sync-gitee:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      status: ${{ steps.sync.outcome }}
      duration: ${{ steps.sync.outputs.duration }}
      configured: ${{ steps.sync.outputs.configured }}
    
    steps:
      - name: æ£€å‡ºæºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}  # ä»Ž whzhni1/ipk_apk æ£€å‡º
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨ PAT Token

      - name: è®¾ç½® Git é…ç½®
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: åŒæ­¥åˆ° Gitee
        id: sync
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          START_TIME=$(date +%s)
          
          if [ -z "$GITEE_TOKEN" ]; then
            echo "configured=æœªè®¾ç½®" >> $GITHUB_OUTPUT
            echo "duration=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "configured=å·²è®¾ç½®" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ æºä»“åº“: ${{ env.SOURCE_REPO }}"
          echo "ðŸŽ¯ ç›®æ ‡: Gitee - ${{ env.USERNAME }}/${{ env.REPO }}"
          
          git remote add gitee https://oauth2:${GITEE_TOKEN}@gitee.com/${{ env.USERNAME }}/${{ env.REPO }}.git || true
          git fetch gitee || true
          git push gitee +${{ env.BRANCH }}:${{ env.BRANCH }}
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          
          echo "âœ… Gitee åŒæ­¥å®Œæˆ (è€—æ—¶ ${DURATION}s)"

  sync-gitcode:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || github.event.workflow_run.conclusion == 'success' }}
    outputs:
      status: ${{ steps.sync.outcome }}
      duration: ${{ steps.sync.outputs.duration }}
      configured: ${{ steps.sync.outputs.configured }}
    
    steps:
      - name: æ£€å‡ºæºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}  # ä»Ž whzhni1/ipk_apk æ£€å‡º
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨ PAT Token

      - name: è®¾ç½® Git é…ç½®
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: åŒæ­¥åˆ° GitCode
        id: sync
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
        run: |
          START_TIME=$(date +%s)
          
          if [ -z "$GITCODE_TOKEN" ]; then
            echo "configured=æœªè®¾ç½®" >> $GITHUB_OUTPUT
            echo "duration=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "configured=å·²è®¾ç½®" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ æºä»“åº“: ${{ env.SOURCE_REPO }}"
          echo "ðŸŽ¯ ç›®æ ‡: GitCode - ${{ env.USERNAME }}/${{ env.REPO }}"
          
          git remote add gitcode https://oauth2:${GITCODE_TOKEN}@gitcode.com/${{ env.USERNAME }}/${{ env.REPO }}.git || true
          git fetch gitcode || true
          git push gitcode +${{ env.BRANCH }}:${{ env.BRANCH }}
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          
          echo "âœ… GitCode åŒæ­¥å®Œæˆ (è€—æ—¶ ${DURATION}s)"

  report:
    runs-on: ubuntu-latest
    needs: [sync-gitee, sync-gitcode]
    if: always()
    
    steps:
      - name: ç”ŸæˆåŒæ­¥æŠ¥å‘Š
        run: |
          # èŽ·å–æ•°æ®
          GITEE_STATUS="${{ needs.sync-gitee.result }}"
          GITCODE_STATUS="${{ needs.sync-gitcode.result }}"
          GITEE_CONFIGURED="${{ needs.sync-gitee.outputs.configured }}"
          GITCODE_CONFIGURED="${{ needs.sync-gitcode.outputs.configured }}"
          GITEE_DURATION="${{ needs.sync-gitee.outputs.duration }}"
          GITCODE_DURATION="${{ needs.sync-gitcode.outputs.duration }}"
          
          # è®¾ç½®é»˜è®¤å€¼
          GITEE_DURATION=${GITEE_DURATION:-0}
          GITCODE_DURATION=${GITCODE_DURATION:-0}
          GITEE_CONFIGURED=${GITEE_CONFIGURED:-æœªè®¾ç½®}
          GITCODE_CONFIGURED=${GITCODE_CONFIGURED:-æœªè®¾ç½®}
          
          # åˆ¤æ–­çŠ¶æ€
          if [ "$GITEE_CONFIGURED" == "æœªè®¾ç½®" ]; then
            GITEE_ICON="âš™ï¸"
            GITEE_TEXT="æœªé…ç½®"
          elif [ "$GITEE_STATUS" == "success" ]; then
            GITEE_ICON="âœ…"
            GITEE_TEXT="æˆåŠŸ"
          else
            GITEE_ICON="âŒ"
            GITEE_TEXT="å¤±è´¥"
          fi
          
          if [ "$GITCODE_CONFIGURED" == "æœªè®¾ç½®" ]; then
            GITCODE_ICON="âš™ï¸"
            GITCODE_TEXT="æœªé…ç½®"
          elif [ "$GITCODE_STATUS" == "success" ]; then
            GITCODE_ICON="âœ…"
            GITCODE_TEXT="æˆåŠŸ"
          else
            GITCODE_ICON="âŒ"
            GITCODE_TEXT="å¤±è´¥"
          fi
          
          # è§¦å‘æ–¹å¼
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            TRIGGER="ä¸»å·¥ä½œæµå®Œæˆ"
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            TRIGGER="å®šæ—¶ä»»åŠ¡"
          else
            TRIGGER="æ‰‹åŠ¨è§¦å‘"
          fi
          
          # ç”Ÿæˆ Summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ”„ é•œåƒåŒæ­¥æŠ¥å‘Š
          
          **æºä»“åº“**: [${{ env.SOURCE_REPO }}](https://github.com/${{ env.SOURCE_REPO }})  
          **è§¦å‘æ–¹å¼**: $TRIGGER  
          **è§¦å‘æ—¶é—´**: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)  
          **åˆ†æ”¯**: \`${{ env.BRANCH }}\`
          
          ---
          
          ### ðŸ“‹ åŒæ­¥ç»“æžœ
          
          | åŒæ­¥ç›®æ ‡ | åŒæ­¥çŠ¶æ€ | åŒæ­¥ç”¨æ—¶ | TokençŠ¶æ€ |
          |---------|---------|---------|----------|
          | Gitee | $GITEE_ICON $GITEE_TEXT | ${GITEE_DURATION}s | $GITEE_CONFIGURED |
          | GitCode | $GITCODE_ICON $GITCODE_TEXT | ${GITCODE_DURATION}s | $GITCODE_CONFIGURED |
          
          ---
          
          ### ðŸŒ é•œåƒä»“åº“åœ°å€
          
          - ðŸ™ **GitHub**: https://github.com/${{ env.USERNAME }}/${{ env.REPO }}
          - ðŸŸ  **Gitee**: https://gitee.com/${{ env.USERNAME }}/${{ env.REPO }}
          - ðŸ”µ **GitCode**: https://gitcode.com/${{ env.USERNAME }}/${{ env.REPO }}
          
          ---
          
          ### ðŸ“ é…ç½®è¯´æ˜Ž
          
          $(if [ "$GITEE_CONFIGURED" == "æœªè®¾ç½®" ]; then
            echo "**Gitee**: éœ€åœ¨ä»“åº“ Settings â†’ Secrets ä¸­æ·»åŠ  \`GITEE_TOKEN\`"
          fi)
          
          $(if [ "$GITCODE_CONFIGURED" == "æœªè®¾ç½®" ]; then
            echo "**GitCode**: éœ€åœ¨ä»“åº“ Settings â†’ Secrets ä¸­æ·»åŠ  \`GITCODE_TOKEN\`"
          fi)
          EOF
          
          # Annotation
          echo "::notice title=é•œåƒåŒæ­¥æŠ¥å‘Š::æº: ${{ env.SOURCE_REPO }} | è§¦å‘: $TRIGGER | Gitee: $GITEE_ICON $GITEE_TEXT (${GITEE_DURATION}s) | GitCode: $GITCODE_ICON $GITCODE_TEXT (${GITCODE_DURATION}s)"
