name: ÂêåÊ≠•‰ªìÂ∫ìÂíåÈïúÂÉè

on:
  workflow_dispatch:  # ÊâãÂä®Ëß¶Âèë
  push:               # Â∑•ÂÖ∑Êñá‰ª∂ÊîπÂä®Ëß¶Âèë
    branches:
      - main
    paths:
      - 'auto-update.sh'
      - 'auto-setup'
      - 'third-party-installer.sh'
  workflow_run:       # ‰∏ªÂ∑•‰ΩúÊµÅÂÆåÊàêËß¶Âèë
    workflows: ["ÂêåÊ≠•‰∏äÊ∏∏ÂèëÂ∏ÉÁâàÊú¨"]
    types:
      - completed
  schedule:           # ÂÆöÊó∂ÂêåÊ≠•
    - cron: '30 19 * * *'

env:
  SOURCE_REPO: whzhni1/ipk_apk    # GitHub Ê∫ê‰ªìÂ∫ì
  GITEE_USERNAME: whzhni          # Gitee Áî®Êà∑Âêç
  GITCODE_USERNAME: whzhni        # GitCode Áî®Êà∑Âêç
  REPO: ipk_apk
  BRANCH: main
  FILES_TO_SYNC: 'auto-update.sh auto-setup third-party-installer.sh'

jobs:
  # ========================================
  # Èò∂ÊÆµ1: ÂêåÊ≠•Êñá‰ª∂Âà∞ GitHubÔºà‰ªÖ push Ëß¶ÂèëÔºâ
  # ========================================
  sync-files-to-github:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'  # Âè™Âú® push Êó∂ÊâßË°å
    outputs:
      files_changed: ${{ steps.sync.outputs.files_changed }}
    
    steps:
      - name: Ê£ÄÂá∫Êú¨‰ªìÂ∫ì
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: source

      - name: Ê£ÄÂá∫ÁõÆÊ†á‰ªìÂ∫ì
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0
          path: target

      - name: ÈÖçÁΩÆ Git
        run: |
          cd target
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ÂêåÊ≠•Êñá‰ª∂
        id: sync
        run: |
          cd target
          
          echo "========================================="
          echo "üìã ÂêåÊ≠•Êñá‰ª∂Âà∞ ${{ env.SOURCE_REPO }}"
          echo "========================================="
          
          FILES_CHANGED=false
          CHANGED_FILES=""
          
          for file in ${{ env.FILES_TO_SYNC }}; do
            if [ -f "../source/$file" ]; then
              cp "../source/$file" "./$file"
              
              if git diff --quiet "$file"; then
                echo "‚è≠Ô∏è  $file (Êó†ÂèòÂåñ)"
              else
                echo "‚úÖ $file (Â∑≤Êõ¥Êñ∞)"
                FILES_CHANGED=true
                CHANGED_FILES="$CHANGED_FILES $file"
              fi
            else
              echo "‚ö†Ô∏è  $file (Ê∫êÊñá‰ª∂‰∏çÂ≠òÂú®)"
            fi
          done
          
          echo ""
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          
          if [ "$FILES_CHANGED" = "true" ]; then
            echo "üìù ÂèòÊõ¥Êñá‰ª∂:$CHANGED_FILES"
            
            git add ${{ env.FILES_TO_SYNC }}
            
            git commit -m "üîÑ ÂêåÊ≠•Â∑•ÂÖ∑ËÑöÊú¨Êõ¥Êñ∞

            ÂèòÊõ¥Êñá‰ª∂:$CHANGED_FILES

            - Êù•Ê∫ê: ${{ github.repository }}
            - Êèê‰∫§: ${{ github.sha }}
            - Êó∂Èó¥: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (Âåó‰∫¨Êó∂Èó¥)"
            
            echo "üöÄ Êé®ÈÄÅÂà∞ ${{ env.SOURCE_REPO }}..."
            git push
            
            echo "‚úÖ GitHub ÂêåÊ≠•ÂÆåÊàê"
          else
            echo "‚ÑπÔ∏è  Êó†Êñá‰ª∂ÂèòÊõ¥ÔºåË∑≥ËøáÊé®ÈÄÅ"
          fi

  # ========================================
  # Èò∂ÊÆµ2: ÂêåÊ≠•Âà∞ Gitee
  # ========================================
  sync-to-gitee:
    runs-on: ubuntu-latest
    needs: [sync-files-to-github]
    if: |
      always() && 
      !contains(needs.*.result, 'failure') && 
      !contains(needs.*.result, 'cancelled') &&
      (github.event_name == 'workflow_dispatch' || 
       github.event_name == 'schedule' || 
       github.event_name == 'push' ||
       (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'))
    outputs:
      status: ${{ steps.sync.outcome }}
      duration: ${{ steps.sync.outputs.duration }}
      configured: ${{ steps.sync.outputs.configured }}
    
    steps:
      - name: Á≠âÂæÖ GitHub ÂêåÊ≠•ÂÆåÊàê
        if: github.event_name == 'push'
        run: |
          echo "‚è≥ Á≠âÂæÖ5ÁßíÁ°Æ‰øù GitHub ÂêåÊ≠•ÂÆåÊàê..."
          sleep 5

      - name: Ê£ÄÂá∫Ê∫ê‰ªìÂ∫ì
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: ÈÖçÁΩÆ Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ÂêåÊ≠•Âà∞ Gitee
        id: sync
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          START_TIME=$(date +%s)
          
          if [ -z "$GITEE_TOKEN" ]; then
            echo "‚ö†Ô∏è GITEE_TOKEN Êú™ËÆæÁΩÆ"
            echo "configured=Êú™ËÆæÁΩÆ" >> $GITHUB_OUTPUT
            echo "duration=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "configured=Â∑≤ËÆæÁΩÆ" >> $GITHUB_OUTPUT
          
          echo "========================================="
          echo "üìã Ê∫ê‰ªìÂ∫ì: ${{ env.SOURCE_REPO }}"
          echo "üéØ ÁõÆÊ†á: https://gitee.com/${{ env.GITEE_USERNAME }}/${{ env.REPO }}"
          echo "========================================="
          
          git remote add gitee https://oauth2:${GITEE_TOKEN}@gitee.com/${{ env.GITEE_USERNAME }}/${{ env.REPO }}.git 2>/dev/null || \
          git remote set-url gitee https://oauth2:${GITEE_TOKEN}@gitee.com/${{ env.GITEE_USERNAME }}/${{ env.REPO }}.git
          
          echo "üöÄ ÂºÄÂßãÊé®ÈÄÅ..."
          git push gitee +${{ env.BRANCH }}:${{ env.BRANCH }}
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Gitee ÂêåÊ≠•ÂÆåÊàê (ËÄóÊó∂ ${DURATION}s)"

  # ========================================
  # Èò∂ÊÆµ3: ÂêåÊ≠•Âà∞ GitCode
  # ========================================
  sync-to-gitcode:
    runs-on: ubuntu-latest
    needs: [sync-files-to-github]
    if: |
      always() && 
      !contains(needs.*.result, 'failure') && 
      !contains(needs.*.result, 'cancelled') &&
      (github.event_name == 'workflow_dispatch' || 
       github.event_name == 'schedule' || 
       github.event_name == 'push' ||
       (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'))
    outputs:
      status: ${{ steps.sync.outcome }}
      duration: ${{ steps.sync.outputs.duration }}
      configured: ${{ steps.sync.outputs.configured }}
    
    steps:
      - name: Á≠âÂæÖ GitHub ÂêåÊ≠•ÂÆåÊàê
        if: github.event_name == 'push'
        run: |
          echo "‚è≥ Á≠âÂæÖ5ÁßíÁ°Æ‰øù GitHub ÂêåÊ≠•ÂÆåÊàê..."
          sleep 5

      - name: Ê£ÄÂá∫Ê∫ê‰ªìÂ∫ì
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: ÈÖçÁΩÆ Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ÂêåÊ≠•Âà∞ GitCode
        id: sync
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
        run: |
          START_TIME=$(date +%s)
          
          if [ -z "$GITCODE_TOKEN" ]; then
            echo "‚ö†Ô∏è GITCODE_TOKEN Êú™ËÆæÁΩÆ"
            echo "configured=Êú™ËÆæÁΩÆ" >> $GITHUB_OUTPUT
            echo "duration=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "configured=Â∑≤ËÆæÁΩÆ" >> $GITHUB_OUTPUT
          
          echo "========================================="
          echo "üìã Ê∫ê‰ªìÂ∫ì: ${{ env.SOURCE_REPO }}"
          echo "üéØ ÁõÆÊ†á: https://gitcode.com/${{ env.GITCODE_USERNAME }}/${{ env.REPO }}"
          echo "========================================="
          
          git remote add gitcode https://oauth2:${GITCODE_TOKEN}@gitcode.com/${{ env.GITCODE_USERNAME }}/${{ env.REPO }}.git 2>/dev/null || \
          git remote set-url gitcode https://oauth2:${GITCODE_TOKEN}@gitcode.com/${{ env.GITCODE_USERNAME }}/${{ env.REPO }}.git
          
          echo "üöÄ ÂºÄÂßãÊé®ÈÄÅ..."
          git push gitcode +${{ env.BRANCH }}:${{ env.BRANCH }}
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          
          echo "‚úÖ GitCode ÂêåÊ≠•ÂÆåÊàê (ËÄóÊó∂ ${DURATION}s)"

  # ========================================
  # Èò∂ÊÆµ4: ÁîüÊàêÊä•Âëä
  # ========================================
  report:
    runs-on: ubuntu-latest
    needs: [sync-files-to-github, sync-to-gitee, sync-to-gitcode]
    if: always()
    
    steps:
      - name: ÁîüÊàêÂêåÊ≠•Êä•Âëä
        run: |
          # Ëé∑ÂèñÂêÑÈò∂ÊÆµÁä∂ÊÄÅ
          GITHUB_SYNC_STATUS="${{ needs.sync-files-to-github.result }}"
          FILES_CHANGED="${{ needs.sync-files-to-github.outputs.files_changed }}"
          GITEE_STATUS="${{ needs.sync-to-gitee.result }}"
          GITCODE_STATUS="${{ needs.sync-to-gitcode.result }}"
          GITEE_CONFIGURED="${{ needs.sync-to-gitee.outputs.configured }}"
          GITCODE_CONFIGURED="${{ needs.sync-to-gitcode.outputs.configured }}"
          GITEE_DURATION="${{ needs.sync-to-gitee.outputs.duration }}"
          GITCODE_DURATION="${{ needs.sync-to-gitcode.outputs.duration }}"
          
          # ËÆæÁΩÆÈªòËÆ§ÂÄº
          GITEE_DURATION=${GITEE_DURATION:-0}
          GITCODE_DURATION=${GITCODE_DURATION:-0}
          GITEE_CONFIGURED=${GITEE_CONFIGURED:-Êú™ËÆæÁΩÆ}
          GITCODE_CONFIGURED=${GITCODE_CONFIGURED:-Êú™ËÆæÁΩÆ}
          FILES_CHANGED=${FILES_CHANGED:-false}
          
          # Âà§Êñ≠ GitHub ÂêåÊ≠•Áä∂ÊÄÅ
          if [ "${{ github.event_name }}" == "push" ]; then
            if [ "$GITHUB_SYNC_STATUS" == "success" ]; then
              if [ "$FILES_CHANGED" == "true" ]; then
                GITHUB_ICON="‚úÖ"
                GITHUB_TEXT="Â∑≤Êõ¥Êñ∞"
              else
                GITHUB_ICON="‚ÑπÔ∏è"
                GITHUB_TEXT="Êó†ÂèòÊõ¥"
              fi
            elif [ "$GITHUB_SYNC_STATUS" == "skipped" ]; then
              GITHUB_ICON="‚è≠Ô∏è"
              GITHUB_TEXT="Ë∑≥Ëøá"
            else
              GITHUB_ICON="‚ùå"
              GITHUB_TEXT="Â§±Ë¥•"
            fi
          else
            GITHUB_ICON="‚ûñ"
            GITHUB_TEXT="Êú™ÊâßË°å"
          fi
          
          # Âà§Êñ≠ Gitee Áä∂ÊÄÅ
          if [ "$GITEE_CONFIGURED" == "Êú™ËÆæÁΩÆ" ]; then
            GITEE_ICON="‚öôÔ∏è"
            GITEE_TEXT="Êú™ÈÖçÁΩÆ"
          elif [ "$GITEE_STATUS" == "success" ]; then
            GITEE_ICON="‚úÖ"
            GITEE_TEXT="ÊàêÂäü"
          elif [ "$GITEE_STATUS" == "skipped" ]; then
            GITEE_ICON="‚è≠Ô∏è"
            GITEE_TEXT="Ë∑≥Ëøá"
          else
            GITEE_ICON="‚ùå"
            GITEE_TEXT="Â§±Ë¥•"
          fi
          
          # Âà§Êñ≠ GitCode Áä∂ÊÄÅ
          if [ "$GITCODE_CONFIGURED" == "Êú™ËÆæÁΩÆ" ]; then
            GITCODE_ICON="‚öôÔ∏è"
            GITCODE_TEXT="Êú™ÈÖçÁΩÆ"
          elif [ "$GITCODE_STATUS" == "success" ]; then
            GITCODE_ICON="‚úÖ"
            GITCODE_TEXT="ÊàêÂäü"
          elif [ "$GITCODE_STATUS" == "skipped" ]; then
            GITCODE_ICON="‚è≠Ô∏è"
            GITCODE_TEXT="Ë∑≥Ëøá"
          else
            GITCODE_ICON="‚ùå"
            GITCODE_TEXT="Â§±Ë¥•"
          fi
          
          # Ëß¶ÂèëÊñπÂºè
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            TRIGGER="‰∏ªÂ∑•‰ΩúÊµÅÂÆåÊàê"
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            TRIGGER="ÂÆöÊó∂‰ªªÂä°"
          elif [ "${{ github.event_name }}" == "push" ]; then
            TRIGGER="Êñá‰ª∂ÊîπÂä®"
          else
            TRIGGER="ÊâãÂä®Ëß¶Âèë"
          fi
          
          # ÁîüÊàêÊä•Âëä
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # üîÑ ÂêåÊ≠•Êä•Âëä
          
          **Ëß¶ÂèëÊñπÂºè**: $TRIGGER  
          **Ëß¶ÂèëÊó∂Èó¥**: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (Âåó‰∫¨Êó∂Èó¥)  
          **ÂàÜÊîØ**: \`${{ env.BRANCH }}\`
          
          ---
          
          ### üìã ÂêåÊ≠•ÁªìÊûú
          
          | ÂêåÊ≠•ÁõÆÊ†á | ÂêåÊ≠•Áä∂ÊÄÅ | ÂêåÊ≠•Áî®Êó∂ | ÈÖçÁΩÆÁä∂ÊÄÅ |
          |---------|---------|---------|----------|
          | GitHub Ê∫ê‰ªìÂ∫ì | $GITHUB_ICON $GITHUB_TEXT | - | - |
          | Gitee | $GITEE_ICON $GITEE_TEXT | ${GITEE_DURATION}s | $GITEE_CONFIGURED |
          | GitCode | $GITCODE_ICON $GITCODE_TEXT | ${GITCODE_DURATION}s | $GITCODE_CONFIGURED |
          
          ---
          
          ### üåê ‰ªìÂ∫ìÂú∞ÂùÄ
          
          - üêô **GitHub**: https://github.com/${{ env.SOURCE_REPO }}
          - üü† **Gitee**: https://gitee.com/${{ env.GITEE_USERNAME }}/${{ env.REPO }}
          - üîµ **GitCode**: https://gitcode.com/${{ env.GITCODE_USERNAME }}/${{ env.REPO }}
          
          ---
          
          ### üìÅ ÂêåÊ≠•Êñá‰ª∂ÂàóË°®
          
          EOF
          
          # ÊòæÁ§∫ÂêåÊ≠•ÁöÑÊñá‰ª∂
          if [ "${{ github.event_name }}" == "push" ]; then
            for file in ${{ env.FILES_TO_SYNC }}; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "_Êú¨Ê¨°Ëß¶Âèë‰∏çÊ∂âÂèäÊñá‰ª∂ÂêåÊ≠•_" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Ê∑ªÂä†ÈÖçÁΩÆÊèêÁ§∫
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$GITEE_CONFIGURED" == "Êú™ËÆæÁΩÆ" ] || [ "$GITCODE_CONFIGURED" == "Êú™ËÆæÁΩÆ" ]; then
            echo "### ‚öôÔ∏è ÈÖçÁΩÆÊèêÁ§∫" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "$GITEE_CONFIGURED" == "Êú™ËÆæÁΩÆ" ]; then
              echo "- **Gitee**: ÈúÄÂú®‰ªìÂ∫ì Settings ‚Üí Secrets ‰∏≠Ê∑ªÂä† \`GITEE_TOKEN\`" >> $GITHUB_STEP_SUMMARY
            fi
            if [ "$GITCODE_CONFIGURED" == "Êú™ËÆæÁΩÆ" ]; then
              echo "- **GitCode**: ÈúÄÂú®‰ªìÂ∫ì Settings ‚Üí Secrets ‰∏≠Ê∑ªÂä† \`GITCODE_TOKEN\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          # Annotation
          echo "::notice title=ÂêåÊ≠•Êä•Âëä::Ëß¶Âèë: $TRIGGER | GitHub: $GITHUB_ICON | Gitee: $GITEE_ICON (${GITEE_DURATION}s) | GitCode: $GITCODE_ICON (${GITCODE_DURATION}s)"
