name: æž„å»º OpenList2 è½¯ä»¶åŒ…

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 19 * * *'  # åŒ—äº¬æ—¶é—´ 3:00 AM = UTC 19:00

env:
  SOURCE_REPO: sbwml/luci-app-openlist2      # ä¸Šæ¸¸ä»“åº“
  TARGET_REPO: whzhni1/ipk_apk               # ç›®æ ‡ä»“åº“
  TARGET_DIR: openlist                       # ç›®æ ‡ç›®å½•
  BRANCH: main

jobs:
  # ========================================
  # é˜¶æ®µ1: æ£€æŸ¥ç‰ˆæœ¬
  # ========================================
  check-version:
    runs-on: ubuntu-latest
    outputs:
      has_update: ${{ steps.check.outputs.has_update }}
      latest_version: ${{ steps.check.outputs.latest_version }}
      current_version: ${{ steps.check.outputs.current_version }}
    
    steps:
      - name: èŽ·å–ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬
        id: upstream
        run: |
          echo "ðŸ” æ£€æŸ¥ä¸Šæ¸¸ä»“åº“æœ€æ–°ç‰ˆæœ¬..."
          
          # èŽ·å–æœ€æ–° tag
          LATEST_TAG=$(curl -s "https://api.github.com/repos/${{ env.SOURCE_REPO }}/tags" | \
            jq -r '.[0].name')
          
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä¸Šæ¸¸ç‰ˆæœ¬"
            echo "has_tag=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_tag=true" >> $GITHUB_OUTPUT
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "âœ… ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬: $LATEST_TAG"

      - name: æ£€å‡ºç›®æ ‡ä»“åº“
        if: steps.upstream.outputs.has_tag == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬
        id: check
        if: steps.upstream.outputs.has_tag == 'true'
        run: |
          LATEST_VERSION="${{ steps.upstream.outputs.latest_tag }}"
          
          echo "ðŸ” æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬..."
          
          if [ ! -d "${{ env.TARGET_DIR }}" ]; then
            echo "ðŸ“ ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º"
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "current_version=none" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # èŽ·å–æœ¬åœ°ç‰ˆæœ¬ï¼ˆç›®å½•åï¼‰
          CURRENT_VERSION=$(ls -1 "${{ env.TARGET_DIR }}" 2>/dev/null | grep -v "^\." | head -n 1)
          
          if [ -z "$CURRENT_VERSION" ]; then
            echo "ðŸ“ ç›®å½•ä¸ºç©º"
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "current_version=none" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ“Œ å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          echo "ðŸ“Œ æœ€æ–°ç‰ˆæœ¬: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "ðŸ”„ å‘çŽ°æ–°ç‰ˆæœ¬"
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
            echo "has_update=false" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          fi

  # ========================================
  # é˜¶æ®µ2: ç¼–è¯‘è½¯ä»¶åŒ…
  # ========================================
  build:
    name: æž„å»º ${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.has_update == 'true'
    strategy:
      fail-fast: false
      matrix:
        arch:
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - arm_arm1176jzf-s_vfp
          - arm_arm926ej-s
          - arm_cortex-a15_neon-vfpv4
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a7_vfpv4
          - arm_cortex-a8_vfpv3
          - arm_cortex-a9
          - arm_cortex-a9_neon
          - arm_cortex-a9_vfpv3-d16
          - arm_fa526
          - arm_xscale
          - i386_pentium-mmx
          - i386_pentium4
          - loongarch64_generic
          - mips64_mips64r2
          - mips64_octeonplus
          - mips64el_mips64r2
          - mips_24kc
          - mips_4kec
          - mips_mips32
          - mipsel_24kc
          - mipsel_24kc_24kf
          - mipsel_74kc
          - mipsel_mips32
          - riscv64_riscv64
          - x86_64
        sdk:
          - openwrt-24.10
          - SNAPSHOT

    steps:
      - name: æ£€å‡ºä¸Šæ¸¸ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          ref: ${{ needs.check-version.outputs.latest_version }}
          fetch-depth: 0

      - name: é…ç½®é™æ€é“¾æŽ¥
        run: |
          sed -i '/golang-package/a \\tGO_PKG_DEFAULT_LDFLAGS:=-w -s -extldflags "-static"' openlist2/Makefile

      - name: é…ç½® UPX åŽ‹ç¼©
        if: ${{ matrix.arch != 'loongarch64_generic' && matrix.arch != 'mips64_mips64r2' && matrix.arch != 'mips64_octeonplus' && matrix.arch != 'mips64el_mips64r2' && matrix.arch != 'riscv64_riscv64' }}
        run: |
          sed -i '/openlist2.init/a \\t/usr/bin/upx --lzma --best $(1)\/usr\/bin\/openlist2' openlist2/Makefile

      - name: æž„å»ºè½¯ä»¶åŒ…
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: luci-app-openlist2
          NO_REFRESH_CHECK: true

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.arch }}-${{ matrix.sdk }}
          path: |
            bin/packages/${{ matrix.arch }}/packages_ci/*.apk
            bin/packages/${{ matrix.arch }}/packages_ci/*.ipk
            bin/packages/riscv64_generic/packages_ci/*.apk
            bin/packages/riscv64_generic/packages_ci/*.ipk
          retention-days: 1

  # ========================================
  # é˜¶æ®µ3: æ”¶é›†å¹¶æŽ¨é€åˆ°ç›®æ ‡ä»“åº“
  # ========================================
  deploy:
    runs-on: ubuntu-latest
    needs: [check-version, build]
    if: needs.check-version.outputs.has_update == 'true'
    
    steps:
      - name: æ£€å‡ºç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: packages-*
          path: artifacts
          merge-multiple: false

      - name: æ•´ç†æ–‡ä»¶
        run: |
          LATEST_VERSION="${{ needs.check-version.outputs.latest_version }}"
          CURRENT_VERSION="${{ needs.check-version.outputs.current_version }}"
          
          echo "========================================="
          echo "ðŸ“¦ æ•´ç†ç¼–è¯‘æ–‡ä»¶"
          echo "========================================="
          echo "ç‰ˆæœ¬: $LATEST_VERSION"
          echo ""
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p "${{ env.TARGET_DIR }}/$LATEST_VERSION"
          
          # ç»Ÿè®¡æ–‡ä»¶
          TOTAL_FILES=0
          
          # éåŽ†æ‰€æœ‰æž¶æž„çš„äº§ç‰©
          for artifact_dir in artifacts/packages-*/; do
            if [ -d "$artifact_dir" ]; then
              echo "ðŸ“ å¤„ç†: $(basename "$artifact_dir")"
              
              # æŸ¥æ‰¾å¹¶å¤åˆ¶ ipk/apk æ–‡ä»¶
              find "$artifact_dir" -type f \( -name "*.ipk" -o -name "*.apk" \) | while read file; do
                filename=$(basename "$file")
                cp "$file" "${{ env.TARGET_DIR }}/$LATEST_VERSION/"
                echo "  âœ… $filename"
                TOTAL_FILES=$((TOTAL_FILES + 1))
              done
            fi
          done
          
          # ç»Ÿè®¡æœ€ç»ˆæ–‡ä»¶æ•°
          FINAL_COUNT=$(find "${{ env.TARGET_DIR }}/$LATEST_VERSION" -type f \( -name "*.ipk" -o -name "*.apk" \) | wc -l)
          
          echo ""
          echo "ðŸ“Š å…±æ”¶é›† $FINAL_COUNT ä¸ªè½¯ä»¶åŒ…"
          
          # åˆ é™¤æ—§ç‰ˆæœ¬
          if [ "$CURRENT_VERSION" != "none" ] && [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo ""
            echo "ðŸ—‘ï¸  åˆ é™¤æ—§ç‰ˆæœ¬: $CURRENT_VERSION"
            rm -rf "${{ env.TARGET_DIR }}/$CURRENT_VERSION"
          fi
          
          # æ˜¾ç¤ºç›®å½•ç»“æž„
          echo ""
          echo "ðŸ“ ç›®å½•ç»“æž„:"
          tree -L 2 "${{ env.TARGET_DIR }}" || ls -lh "${{ env.TARGET_DIR }}/$LATEST_VERSION" | head -20

      - name: æäº¤å¹¶æŽ¨é€
        run: |
          LATEST_VERSION="${{ needs.check-version.outputs.latest_version }}"
          CURRENT_VERSION="${{ needs.check-version.outputs.current_version }}"
          
          git add "${{ env.TARGET_DIR }}"
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ— éœ€æäº¤"
            exit 0
          fi
          
          # ç»Ÿè®¡æ–‡ä»¶
          FILE_COUNT=$(find "${{ env.TARGET_DIR }}/$LATEST_VERSION" -type f \( -name "*.ipk" -o -name "*.apk" \) | wc -l)
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          if [ "$CURRENT_VERSION" = "none" ]; then
            COMMIT_MSG="ðŸš€ æ·»åŠ  OpenList2 $LATEST_VERSION

          - æ–°å¢žç‰ˆæœ¬: $LATEST_VERSION
          - è½¯ä»¶åŒ…æ•°: $FILE_COUNT
          - ä¸Šæ¸¸ä»“åº“: ${{ env.SOURCE_REPO }}
          - æž„å»ºæ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)"
          else
            COMMIT_MSG="ðŸ”„ æ›´æ–° OpenList2 åˆ° $LATEST_VERSION

          - æ—§ç‰ˆæœ¬: $CURRENT_VERSION
          - æ–°ç‰ˆæœ¬: $LATEST_VERSION
          - è½¯ä»¶åŒ…æ•°: $FILE_COUNT
          - ä¸Šæ¸¸ä»“åº“: ${{ env.SOURCE_REPO }}
          - æ›´æ–°æ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)"
          fi
          
          git commit -m "$COMMIT_MSG"
          
          echo "ðŸš€ æŽ¨é€åˆ° ${{ env.TARGET_REPO }}..."
          git push origin ${{ env.BRANCH }}
          
          echo "âœ… éƒ¨ç½²å®Œæˆ"

  # ========================================
  # é˜¶æ®µ4: ç”ŸæˆæŠ¥å‘Š
  # ========================================
  report:
    runs-on: ubuntu-latest
    needs: [check-version, build, deploy]
    if: always()
    
    steps:
      - name: ç”ŸæˆæŠ¥å‘Š
        run: |
          HAS_UPDATE="${{ needs.check-version.outputs.has_update }}"
          LATEST_VERSION="${{ needs.check-version.outputs.latest_version }}"
          CURRENT_VERSION="${{ needs.check-version.outputs.current_version }}"
          BUILD_STATUS="${{ needs.build.result }}"
          DEPLOY_STATUS="${{ needs.deploy.result }}"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“¦ OpenList2 æž„å»ºæŠ¥å‘Š
          
          **è§¦å‘æ—¶é—´**: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)  
          **ä¸Šæ¸¸ä»“åº“**: [${{ env.SOURCE_REPO }}](https://github.com/${{ env.SOURCE_REPO }})  
          **ç›®æ ‡ä»“åº“**: [${{ env.TARGET_REPO }}](https://github.com/${{ env.TARGET_REPO }})
          
          ---
          
          ### ðŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          
          | é¡¹ç›® | ç‰ˆæœ¬ |
          |------|------|
          | å½“å‰ç‰ˆæœ¬ | \`${CURRENT_VERSION}\` |
          | æœ€æ–°ç‰ˆæœ¬ | \`${LATEST_VERSION}\` |
          | æ˜¯å¦æ›´æ–° | $([ "$HAS_UPDATE" = "true" ] && echo "âœ… æ˜¯" || echo "âŒ å¦") |
          
          ---
          
          ### ðŸ”¨ æž„å»ºçŠ¶æ€
          
          EOF
          
          if [ "$HAS_UPDATE" = "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          | é˜¶æ®µ | çŠ¶æ€ |
          |------|------|
          | ç‰ˆæœ¬æ£€æŸ¥ | âœ… å‘çŽ°æ›´æ–° |
          | è½¯ä»¶åŒ…æž„å»º | $([ "$BUILD_STATUS" = "success" ] && echo "âœ… æˆåŠŸ" || echo "âŒ å¤±è´¥") |
          | æ–‡ä»¶éƒ¨ç½² | $([ "$DEPLOY_STATUS" = "success" ] && echo "âœ… æˆåŠŸ" || echo "âŒ å¤±è´¥") |
          
          ---
          
          ### ðŸŒ ä»“åº“åœ°å€
          
          - ðŸ“¦ **è½¯ä»¶åŒ…ç›®å½•**: https://github.com/${{ env.TARGET_REPO }}/tree/${{ env.BRANCH }}/${{ env.TARGET_DIR }}/$LATEST_VERSION
          - ðŸ”— **ä¸Šæ¸¸é¡¹ç›®**: https://github.com/${{ env.SOURCE_REPO }}
          - ðŸ“‹ **ä¸Šæ¸¸ç‰ˆæœ¬**: https://github.com/${{ env.SOURCE_REPO }}/releases/tag/$LATEST_VERSION
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          **çŠ¶æ€**: â„¹ï¸ å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æž„å»º
          
          å½“å‰ç‰ˆæœ¬ \`$LATEST_VERSION\` å·²æ˜¯æœ€æ–°ï¼Œè·³è¿‡æž„å»ºæµç¨‹ã€‚
          EOF
          fi
          
          # Annotation
          if [ "$HAS_UPDATE" = "true" ]; then
            if [ "$BUILD_STATUS" = "success" ] && [ "$DEPLOY_STATUS" = "success" ]; then
              echo "::notice title=æž„å»ºæˆåŠŸ::OpenList2 å·²æ›´æ–°åˆ° $LATEST_VERSION"
            else
              echo "::error title=æž„å»ºå¤±è´¥::OpenList2 $LATEST_VERSION æž„å»ºæˆ–éƒ¨ç½²å¤±è´¥"
            fi
          else
            echo "::notice title=æ— éœ€æ›´æ–°::å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ $LATEST_VERSION"
          fi
