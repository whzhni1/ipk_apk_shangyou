name: æž„å»º OpenList2 è½¯ä»¶åŒ…

on:
  workflow_dispatch:
  schedule:
    - cron: '0 19 * * *'

env:
  SOURCE_REPO: sbwml/luci-app-openlist2
  TARGET_REPO: whzhni1/ipk_apk
  TARGET_DIR: openlist
  BRANCH: main

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      has_update: ${{ steps.check.outputs.has_update }}
      latest_version: ${{ steps.check.outputs.latest_version }}
      current_version: ${{ steps.check.outputs.current_version }}
    
    steps:
      - name: èŽ·å–ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬
        id: upstream
        run: |
          echo "ðŸ” æ£€æŸ¥ä¸Šæ¸¸ä»“åº“æœ€æ–°ç‰ˆæœ¬..."
          
          LATEST_TAG=$(curl -s "https://api.github.com/repos/${{ env.SOURCE_REPO }}/tags" | \
            jq -r '.[0].name')
          
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä¸Šæ¸¸ç‰ˆæœ¬"
            echo "has_tag=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_tag=true" >> $GITHUB_OUTPUT
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "âœ… ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬: $LATEST_TAG"

      - name: æ£€å‡ºç›®æ ‡ä»“åº“
        if: steps.upstream.outputs.has_tag == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬
        id: check
        if: steps.upstream.outputs.has_tag == 'true'
        run: |
          LATEST_VERSION="${{ steps.upstream.outputs.latest_tag }}"
          
          echo "ðŸ” æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬..."
          
          if [ ! -d "${{ env.TARGET_DIR }}" ]; then
            echo "ðŸ“ ç›®å½•ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º"
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "current_version=none" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CURRENT_VERSION=$(ls -1 "${{ env.TARGET_DIR }}" 2>/dev/null | grep -v "^\." | head -n 1)
          
          if [ -z "$CURRENT_VERSION" ]; then
            echo "ðŸ“ ç›®å½•ä¸ºç©º"
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "current_version=none" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ“Œ å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          echo "ðŸ“Œ æœ€æ–°ç‰ˆæœ¬: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "ðŸ”„ å‘çŽ°æ–°ç‰ˆæœ¬"
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
            echo "has_update=false" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          fi

  build:
    name: æž„å»º ${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    needs: check-version
    if: needs.check-version.outputs.has_update == 'true'
    strategy:
      fail-fast: false
      matrix:
        arch:
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - arm_arm1176jzf-s_vfp
          - arm_arm926ej-s
          - arm_cortex-a15_neon-vfpv4
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a7_vfpv4
          - arm_cortex-a8_vfpv3
          - arm_cortex-a9
          - arm_cortex-a9_neon
          - arm_cortex-a9_vfpv3-d16
          - arm_fa526
          - arm_xscale
          - i386_pentium-mmx
          - i386_pentium4
          - loongarch64_generic
          - mips64_mips64r2
          - mips64_octeonplus
          - mips64el_mips64r2
          - mips_24kc
          - mips_4kec
          - mips_mips32
          - mipsel_24kc
          - mipsel_24kc_24kf
          - mipsel_74kc
          - mipsel_mips32
          - riscv64_riscv64
          - x86_64
        sdk:
          - openwrt-24.10
          - SNAPSHOT

    steps:
      - name: æ£€å‡ºä¸Šæ¸¸ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          ref: ${{ needs.check-version.outputs.latest_version }}
          fetch-depth: 0

      - name: é…ç½®é™æ€é“¾æŽ¥
        run: |
          sed -i '/golang-package/a \\tGO_PKG_DEFAULT_LDFLAGS:=-w -s -extldflags "-static"' openlist2/Makefile

      - name: é…ç½® UPX åŽ‹ç¼©
        if: ${{ matrix.arch != 'loongarch64_generic' && matrix.arch != 'mips64_mips64r2' && matrix.arch != 'mips64_octeonplus' && matrix.arch != 'mips64el_mips64r2' && matrix.arch != 'riscv64_riscv64' }}
        run: |
          sed -i '/openlist2.init/a \\t/usr/bin/upx --lzma --best $(1)\/usr\/bin\/openlist2' openlist2/Makefile

      - name: æž„å»ºè½¯ä»¶åŒ…
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: luci-app-openlist2
          NO_REFRESH_CHECK: true

      - name: æ£€æŸ¥ç¼–è¯‘ç»“æžœ
        run: |
          echo "========================================="
          echo "ðŸ“¦ ç¼–è¯‘äº§ç‰©æ£€æŸ¥"
          echo "========================================="
          echo "æž¶æž„: ${{ matrix.arch }}"
          echo "SDK: ${{ matrix.sdk }}"
          echo ""
          
          # æ£€æŸ¥ä¸»æž¶æž„ç›®å½•
          if [ -d "bin/packages/${{ matrix.arch }}/packages_ci" ]; then
            echo "ðŸ“ ä¸»ç›®å½•: bin/packages/${{ matrix.arch }}/packages_ci"
            ls -lh bin/packages/${{ matrix.arch }}/packages_ci/ || true
            echo ""
            echo "IPK æ–‡ä»¶:"
            find bin/packages/${{ matrix.arch }}/packages_ci/ -name "*.ipk" -exec basename {} \; || echo "  æ— "
            echo ""
            echo "APK æ–‡ä»¶:"
            find bin/packages/${{ matrix.arch }}/packages_ci/ -name "*.apk" -exec basename {} \; || echo "  æ— "
          else
            echo "âš ï¸ ä¸»ç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo ""
          
          # æ£€æŸ¥ riscv64_generic ç›®å½•ï¼ˆç‰¹æ®Šå¤„ç†ï¼‰
          if [ "${{ matrix.arch }}" = "riscv64_riscv64" ] && [ -d "bin/packages/riscv64_generic/packages_ci" ]; then
            echo "ðŸ“ ç‰¹æ®Šç›®å½•: bin/packages/riscv64_generic/packages_ci"
            ls -lh bin/packages/riscv64_generic/packages_ci/ || true
          fi
          
          echo "========================================="

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.arch }}-${{ matrix.sdk }}
          path: |
            bin/packages/${{ matrix.arch }}/packages_ci/*.apk
            bin/packages/${{ matrix.arch }}/packages_ci/*.ipk
            bin/packages/riscv64_generic/packages_ci/*.apk
            bin/packages/riscv64_generic/packages_ci/*.ipk
          retention-days: 1
          if-no-files-found: warn

  deploy:
    runs-on: ubuntu-latest
    needs: [check-version, build]
    if: needs.check-version.outputs.has_update == 'true'
    
    steps:
      - name: æ£€å‡ºç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: packages-*
          path: artifacts
          merge-multiple: false

      - name: æ•´ç†æ–‡ä»¶
        run: |
          LATEST_VERSION="${{ needs.check-version.outputs.latest_version }}"
          CURRENT_VERSION="${{ needs.check-version.outputs.current_version }}"
          
          echo "========================================="
          echo "ðŸ“¦ æ•´ç†ç¼–è¯‘æ–‡ä»¶"
          echo "========================================="
          echo "ç‰ˆæœ¬: $LATEST_VERSION"
          echo ""
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p "${{ env.TARGET_DIR }}/$LATEST_VERSION"
          
          # ç»Ÿè®¡å˜é‡
          declare -A file_count
          file_count[ipk]=0
          file_count[apk]=0
          
          # éåŽ†æ‰€æœ‰ artifact
          for artifact_dir in artifacts/packages-*/; do
            if [ ! -d "$artifact_dir" ]; then
              continue
            fi
            
            artifact_name=$(basename "$artifact_dir")
            echo "ðŸ“ å¤„ç†: $artifact_name"
            
            # æ˜¾ç¤ºæ­¤ artifact ä¸­çš„æ–‡ä»¶
            ipk_files=$(find "$artifact_dir" -name "*.ipk" 2>/dev/null | wc -l)
            apk_files=$(find "$artifact_dir" -name "*.apk" 2>/dev/null | wc -l)
            
            echo "   IPK: $ipk_files ä¸ª, APK: $apk_files ä¸ª"
            
            # å¤åˆ¶ IPK æ–‡ä»¶
            find "$artifact_dir" -type f -name "*.ipk" | while read file; do
              filename=$(basename "$file")
              cp "$file" "${{ env.TARGET_DIR }}/$LATEST_VERSION/"
              echo "   âœ… IPK: $filename"
              file_count[ipk]=$((file_count[ipk] + 1))
            done
            
            # å¤åˆ¶ APK æ–‡ä»¶
            find "$artifact_dir" -type f -name "*.apk" | while read file; do
              filename=$(basename "$file")
              cp "$file" "${{ env.TARGET_DIR }}/$LATEST_VERSION/"
              echo "   âœ… APK: $filename"
              file_count[apk]=$((file_count[apk] + 1))
            done
            
            echo ""
          done
          
          # ç»Ÿè®¡æœ€ç»ˆç»“æžœ
          FINAL_IPK=$(find "${{ env.TARGET_DIR }}/$LATEST_VERSION" -type f -name "*.ipk" 2>/dev/null | wc -l)
          FINAL_APK=$(find "${{ env.TARGET_DIR }}/$LATEST_VERSION" -type f -name "*.apk" 2>/dev/null | wc -l)
          TOTAL_FILES=$((FINAL_IPK + FINAL_APK))
          
          echo "========================================="
          echo "ðŸ“Š æ–‡ä»¶ç»Ÿè®¡"
          echo "========================================="
          echo "IPK æ–‡ä»¶: $FINAL_IPK ä¸ª"
          echo "APK æ–‡ä»¶: $FINAL_APK ä¸ª"
          echo "æ€»è®¡: $TOTAL_FILES ä¸ª"
          echo ""
          
          # åˆ é™¤æ—§ç‰ˆæœ¬
          if [ "$CURRENT_VERSION" != "none" ] && [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "ðŸ—‘ï¸  åˆ é™¤æ—§ç‰ˆæœ¬: $CURRENT_VERSION"
            rm -rf "${{ env.TARGET_DIR }}/$CURRENT_VERSION"
          fi
          
          # æ˜¾ç¤ºéƒ¨åˆ†æ–‡ä»¶åˆ—è¡¨
          echo ""
          echo "ðŸ“ æ–‡ä»¶åˆ—è¡¨ï¼ˆå‰20ä¸ªï¼‰:"
          ls -lh "${{ env.TARGET_DIR }}/$LATEST_VERSION" | head -21
          
          echo ""
          echo "âœ… æ•´ç†å®Œæˆ"

      - name: æäº¤å¹¶æŽ¨é€
        run: |
          LATEST_VERSION="${{ needs.check-version.outputs.latest_version }}"
          CURRENT_VERSION="${{ needs.check-version.outputs.current_version }}"
          
          git add "${{ env.TARGET_DIR }}"
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ— éœ€æäº¤"
            exit 0
          fi
          
          # ç»Ÿè®¡æ–‡ä»¶
          IPK_COUNT=$(find "${{ env.TARGET_DIR }}/$LATEST_VERSION" -type f -name "*.ipk" 2>/dev/null | wc -l)
          APK_COUNT=$(find "${{ env.TARGET_DIR }}/$LATEST_VERSION" -type f -name "*.apk" 2>/dev/null | wc -l)
          TOTAL_COUNT=$((IPK_COUNT + APK_COUNT))
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          if [ "$CURRENT_VERSION" = "none" ]; then
            COMMIT_MSG="ðŸš€ æ·»åŠ  OpenList2 $LATEST_VERSION

          - æ–°å¢žç‰ˆæœ¬: $LATEST_VERSION
          - IPK æ–‡ä»¶: $IPK_COUNT ä¸ª
          - APK æ–‡ä»¶: $APK_COUNT ä¸ª
          - æ€»è®¡: $TOTAL_COUNT ä¸ª
          - ä¸Šæ¸¸ä»“åº“: ${{ env.SOURCE_REPO }}
          - æž„å»ºæ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)"
          else
            COMMIT_MSG="ðŸ”„ æ›´æ–° OpenList2 åˆ° $LATEST_VERSION

          - æ—§ç‰ˆæœ¬: $CURRENT_VERSION
          - æ–°ç‰ˆæœ¬: $LATEST_VERSION
          - IPK æ–‡ä»¶: $IPK_COUNT ä¸ª
          - APK æ–‡ä»¶: $APK_COUNT ä¸ª
          - æ€»è®¡: $TOTAL_COUNT ä¸ª
          - ä¸Šæ¸¸ä»“åº“: ${{ env.SOURCE_REPO }}
          - æ›´æ–°æ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)"
          fi
          
          git commit -m "$COMMIT_MSG"
          
          echo "ðŸš€ æŽ¨é€åˆ° ${{ env.TARGET_REPO }}..."
          git push origin ${{ env.BRANCH }}
          
          echo "âœ… éƒ¨ç½²å®Œæˆ"

  report:
    runs-on: ubuntu-latest
    needs: [check-version, build, deploy]
    if: always()
    
    steps:
      - name: ç”ŸæˆæŠ¥å‘Š
        run: |
          HAS_UPDATE="${{ needs.check-version.outputs.has_update }}"
          LATEST_VERSION="${{ needs.check-version.outputs.latest_version }}"
          CURRENT_VERSION="${{ needs.check-version.outputs.current_version }}"
          BUILD_STATUS="${{ needs.build.result }}"
          DEPLOY_STATUS="${{ needs.deploy.result }}"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“¦ OpenList2 æž„å»ºæŠ¥å‘Š
          
          **è§¦å‘æ—¶é—´**: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)  
          **ä¸Šæ¸¸ä»“åº“**: [${{ env.SOURCE_REPO }}](https://github.com/${{ env.SOURCE_REPO }})  
          **ç›®æ ‡ä»“åº“**: [${{ env.TARGET_REPO }}](https://github.com/${{ env.TARGET_REPO }})
          
          ---
          
          ### ðŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          
          | é¡¹ç›® | ç‰ˆæœ¬ |
          |------|------|
          | å½“å‰ç‰ˆæœ¬ | \`${CURRENT_VERSION}\` |
          | æœ€æ–°ç‰ˆæœ¬ | \`${LATEST_VERSION}\` |
          | æ˜¯å¦æ›´æ–° | $([ "$HAS_UPDATE" = "true" ] && echo "âœ… æ˜¯" || echo "âŒ å¦") |
          
          ---
          
          ### ðŸ”¨ æž„å»ºçŠ¶æ€
          
          EOF
          
          if [ "$HAS_UPDATE" = "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          | é˜¶æ®µ | çŠ¶æ€ |
          |------|------|
          | ç‰ˆæœ¬æ£€æŸ¥ | âœ… å‘çŽ°æ›´æ–° |
          | è½¯ä»¶åŒ…æž„å»º | $([ "$BUILD_STATUS" = "success" ] && echo "âœ… æˆåŠŸ" || echo "âŒ å¤±è´¥") |
          | æ–‡ä»¶éƒ¨ç½² | $([ "$DEPLOY_STATUS" = "success" ] && echo "âœ… æˆåŠŸ" || echo "âŒ å¤±è´¥") |
          
          ---
          
          ### ðŸ“Š ç¼–è¯‘è¯´æ˜Ž
          
          - **IPK æ ¼å¼**: OpenWrt 24.10 ç‰ˆæœ¬ï¼ˆä¼ ç»Ÿæ ¼å¼ï¼‰
          - **APK æ ¼å¼**: SNAPSHOT ç‰ˆæœ¬ï¼ˆæ–°æ ¼å¼ï¼ŒAlpine Package Keeperï¼‰
          - **æž¶æž„æ•°é‡**: 33 ä¸ªæž¶æž„
          - **ç†è®ºæ–‡ä»¶æ•°**: çº¦ 66+ ä¸ªï¼ˆæ¯ä¸ªæž¶æž„ Ã— 2 ä¸ª SDK + æž¶æž„æ— å…³åŒ…ï¼‰
          
          > **æ³¨æ„**: luci-app å’Œ luci-i18n åŒ…æ˜¯æž¶æž„æ— å…³çš„ï¼ˆallï¼‰ï¼Œæ¯ä¸ª SDK åªç”Ÿæˆä¸€ä¸ªã€‚  
          > openlist2 æ ¸å¿ƒåŒ…æ˜¯æž¶æž„ç›¸å…³çš„ï¼Œæ¯ä¸ªæž¶æž„ç”Ÿæˆä¸€ä¸ªã€‚
          
          ---
          
          ### ðŸŒ ä»“åº“åœ°å€
          
          - ðŸ“¦ **è½¯ä»¶åŒ…ç›®å½•**: https://github.com/${{ env.TARGET_REPO }}/tree/${{ env.BRANCH }}/${{ env.TARGET_DIR }}/$LATEST_VERSION
          - ðŸ”— **ä¸Šæ¸¸é¡¹ç›®**: https://github.com/${{ env.SOURCE_REPO }}
          - ðŸ“‹ **ä¸Šæ¸¸ç‰ˆæœ¬**: https://github.com/${{ env.SOURCE_REPO }}/releases/tag/$LATEST_VERSION
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          **çŠ¶æ€**: â„¹ï¸ å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æž„å»º
          
          å½“å‰ç‰ˆæœ¬ \`$LATEST_VERSION\` å·²æ˜¯æœ€æ–°ï¼Œè·³è¿‡æž„å»ºæµç¨‹ã€‚
          EOF
          fi
          
          # Annotation
          if [ "$HAS_UPDATE" = "true" ]; then
            if [ "$BUILD_STATUS" = "success" ] && [ "$DEPLOY_STATUS" = "success" ]; then
              echo "::notice title=æž„å»ºæˆåŠŸ::OpenList2 å·²æ›´æ–°åˆ° $LATEST_VERSION"
            else
              echo "::error title=æž„å»ºå¤±è´¥::OpenList2 $LATEST_VERSION æž„å»ºæˆ–éƒ¨ç½²å¤±è´¥"
            fi
          else
            echo "::notice title=æ— éœ€æ›´æ–°::å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ $LATEST_VERSION"
          fi
