name: åŒæ­¥ä¸Šæ¸¸å‘å¸ƒæ’ä»¶

on:
  workflow_dispatch:  # åªä¿ç•™æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    name: åŒæ­¥ ${{ matrix.github_repo }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # OpenClash
          - github_owner: "vernesong"
            github_repo: "OpenClash"
            local_name: "luci-app-OpenClash"
            
          # luci-app-tailscale
          - github_owner: "whzhni1"
            github_repo: "luci-app-tailscale"
            local_name: "tailscale"
            
          # luci-app-lucky
          - github_owner: "gdy666"
            github_repo: "luci-app-lucky"
            local_name: "lucky"
            filter_include: "luci-app-*:1 luci-i18n-*:1 *wanji*"
            
          # luci-theme-aurora
          - github_owner: "eamonxg"
            github_repo: "luci-theme-aurora"
            
          # openwrt-passwall
          - github_owner: "xiaorouji"
            github_repo: "openwrt-passwall"
            local_name: "luci-app-passwall"
            filter_exclude: "luci-19.07* *.zip"
            
          # openwrt-passwall2
          - github_owner: "xiaorouji"
            github_repo: "openwrt-passwall2"
            local_name: "luci-app-passwall2"
            filter_exclude: "luci-19.07* *.zip"


          
          # é…ç½®è¯´æ˜Žï¼š
          # - github_owner: "ä½œè€…å"                    # å¿…å¡«
          # - github_repo: "é¡¹ç›®å"                      # å¿…å¡«  
          # - local_name: "ç›®æ ‡ä»“åº“å"                # å¯é€‰ï¼Œä¸è®¾ç½®åˆ™ä½¿ç”¨ github_repo
          # - filter_exclude: "*.zip *.rar"            # å¯é€‰ï¼ŒæŽ’é™¤åŒ¹é…çš„æ–‡ä»¶ï¼ˆç©ºæ ¼åˆ†éš”å¤šä¸ªæ¨¡å¼ï¼‰
          # - filter_include: "*.ipk *zh-cn*"          # å¯é€‰ï¼Œåªä¿ç•™åŒ¹é…çš„æ–‡ä»¶
          # - filter_include: "luci-app-*:1"           # :1 è¡¨ç¤ºè¯¥æ¨¡å¼åªä¿ç•™ç¬¬1ä¸ªåŒ¹é…çš„æ–‡ä»¶
            
      fail-fast: false
      max-parallel: 3
      
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: é…ç½®è„šæœ¬æƒé™
        run: |
          chmod +x .github/workflows/scripts/release-GitCode.sh
          chmod +x .github/workflows/scripts/release-gitee.sh
          chmod +x .github/workflows/scripts/version-manager.sh
          
      - name: è®¾ç½®æœ¬åœ°åç§°
        id: set-names
        run: |
          local_name="${{ matrix.local_name }}"
          if [ -z "$local_name" ]; then
            local_name="${{ matrix.github_repo }}"
          fi
          
          echo "local_name=$local_name" >> $GITHUB_OUTPUT
          echo "ðŸ“ ä¸Šæ¸¸: ${{ matrix.github_repo }}"
          echo "ðŸ“‚ ä»“åº“: $local_name"
          
      - name: èŽ·å–ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬
        id: get-version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          github_owner="${{ matrix.github_owner }}"
          github_repo="${{ matrix.github_repo }}"
          full_repo="${github_owner}/${github_repo}"
          
          echo "ðŸ“¦ æ£€æŸ¥é¡¹ç›®: $full_repo"
          
          # èŽ·å–æœ€æ–° Tag
          tags_response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$full_repo/tags?per_page=1")
          
          if echo "$tags_response" | jq -e '.[0]' > /dev/null 2>&1; then
            latest_tag=$(echo "$tags_response" | jq -r '.[0].name')
            echo "ðŸ”– æœ€æ–° Tag: $latest_tag"
          else
            echo "âŒ æœªæ‰¾åˆ° Tag"
            echo "has_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # èŽ·å– Release
          release_response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$full_repo/releases/tags/$latest_tag")
          
          if echo "$release_response" | jq -e '.assets' > /dev/null 2>&1; then
            echo "âœ… æ‰¾åˆ° Release"
            echo "$release_response" > /tmp/release.json
            echo "has_release=true" >> $GITHUB_OUTPUT
          else
            # å°è¯•æœ€æ–° Release
            latest_release=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$full_repo/releases/latest")
            
            if echo "$latest_release" | jq -e '.assets' > /dev/null 2>&1; then
              latest_tag=$(echo "$latest_release" | jq -r '.tag_name')
              echo "âœ… ä½¿ç”¨æœ€æ–° Release: $latest_tag"
              echo "$latest_release" > /tmp/release.json
              echo "has_release=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ æœªæ‰¾åˆ° Release"
              echo "has_release=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # è§„èŒƒåŒ–ç‰ˆæœ¬å·
          if [[ "$latest_tag" =~ ^v ]]; then
            normalized_version="$latest_tag"
          else
            normalized_version="v$latest_tag"
          fi
          
          echo "version=$normalized_version" >> $GITHUB_OUTPUT
          
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        id: check-update
        if: steps.get-version.outputs.has_release == 'true'
        run: |
          local_name="${{ steps.set-names.outputs.local_name }}"
          latest_version="${{ steps.get-version.outputs.version }}"
          
          # è¯»å–æœ¬åœ°ç‰ˆæœ¬è®°å½•
          local_version=$(.github/workflows/scripts/version-manager.sh read "$local_name" 2>/dev/null || echo "")
          
          if [ -z "$local_version" ]; then
            echo "ðŸ“ æœ¬åœ°ç‰ˆæœ¬: æ— è®°å½•"
            echo "âœ… éœ€è¦å‘å¸ƒï¼ˆæ–°é¡¹ç›®ï¼‰"
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "local_version=æ–°å»º" >> $GITHUB_OUTPUT
          elif [ "$local_version" != "$latest_version" ]; then
            echo "ðŸ“Œ æœ¬åœ°ç‰ˆæœ¬: $local_version"
            echo "ðŸ†• ä¸Šæ¸¸ç‰ˆæœ¬: $latest_version"
            echo "âœ… éœ€è¦æ›´æ–°"
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "local_version=$local_version" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“Œ å½“å‰ç‰ˆæœ¬: $local_version"
            echo "â„¹ï¸  å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "local_version=$local_version" >> $GITHUB_OUTPUT
          fi

      - name: ä¸‹è½½æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        if: steps.check-update.outputs.needs_update == 'true'
        run: |
          latest_version="${{ steps.get-version.outputs.version }}"
          
          # ä½¿ç”¨ runner ä¸´æ—¶ç›®å½•
          DOWNLOAD_DIR="${{ runner.temp }}/downloads"
          mkdir -p "$DOWNLOAD_DIR"
          
          echo "ðŸ“‚ ä¸‹è½½ç›®å½•: $DOWNLOAD_DIR"
          
          latest_release=$(cat /tmp/release.json)
          download_count=$(echo "$latest_release" | jq '.assets | length')
          
          if [ "$download_count" -eq 0 ]; then
            echo "âš ï¸  æ— é™„ä»¶"
            echo "downloaded=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "ðŸ“¥ å¼€å§‹ä¸‹è½½ $download_count ä¸ªæ–‡ä»¶"
          
          downloaded=0
          failed=0
          
          echo "$latest_release" | jq -r '.assets[] | "\(.browser_download_url)|\(.name)"' | while IFS='|' read -r url filename; do
            if [ -n "$url" ] && [ -n "$filename" ]; then
              if curl -L -f --max-time 300 -o "$DOWNLOAD_DIR/$filename" "$url" 2>/dev/null; then
                size=$(ls -lh "$DOWNLOAD_DIR/$filename" | awk '{print $5}')
                echo "  âœ… $filename ($size)"
                downloaded=$((downloaded + 1))
              else
                echo "  âŒ $filename"
                failed=$((failed + 1))
              fi
            fi
          done
          
          file_count=$(find "$DOWNLOAD_DIR" -type f 2>/dev/null | wc -l)
          
          echo ""
          echo "ðŸ“Š ä¸‹è½½å®Œæˆ: $file_count ä¸ªæ–‡ä»¶"
          
          if [ "$file_count" -eq 0 ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥"
            echo "downloaded=false" >> $GITHUB_ENV
            exit 1
          fi
          
          echo "downloaded=true" >> $GITHUB_ENV
          echo "DOWNLOAD_DIR=$DOWNLOAD_DIR" >> $GITHUB_ENV
          
      - name: åº”ç”¨è¿‡æ»¤è§„åˆ™
        if: env.downloaded == 'true' && (matrix.filter_exclude != '' || matrix.filter_include != '')
        run: |
          latest_version="${{ steps.get-version.outputs.version }}"
          filter_exclude="${{ matrix.filter_exclude }}"
          filter_include="${{ matrix.filter_include }}"
          
          DOWNLOAD_DIR="${{ env.DOWNLOAD_DIR }}"
          TEMP_DIR="${{ runner.temp }}/filtered"
          
          VERSION_NO_V=${latest_version#v}
          
          echo "ðŸ§¹ åº”ç”¨è¿‡æ»¤è§„åˆ™"
          echo "åŒ¹é…ç‰ˆæœ¬: $VERSION_NO_V"
          [ -n "$filter_exclude" ] && echo "æŽ’é™¤: $filter_exclude"
          [ -n "$filter_include" ] && echo "ä¿ç•™: $filter_include"
          
          rm -rf "$TEMP_DIR"
          mkdir -p "$TEMP_DIR"
          
          # ç™½åå•æ¨¡å¼
          if [ -n "$filter_include" ]; then
            declare -A pattern_count
            declare -A pattern_limit
            
            for pattern_rule in $filter_include; do
              if [[ "$pattern_rule" == *:* ]]; then
                pattern="${pattern_rule%:*}"
                limit="${pattern_rule#*:}"
                pattern="${pattern//\{VERSION\}/$VERSION_NO_V}"
                pattern_limit["$pattern"]=$limit
                pattern_count["$pattern"]=0
              else
                pattern="$pattern_rule"
                pattern="${pattern//\{VERSION\}/$VERSION_NO_V}"
                pattern_limit["$pattern"]=999999
                pattern_count["$pattern"]=0
              fi
            done
            
            for file in "$DOWNLOAD_DIR"/*; do
              [ -f "$file" ] || continue
              filename=$(basename "$file")
              
              for pattern in "${!pattern_limit[@]}"; do
                if [[ "$filename" == $pattern ]]; then
                  current_count=${pattern_count["$pattern"]}
                  limit=${pattern_limit["$pattern"]}
                  
                  if [ $current_count -lt $limit ]; then
                    cp "$file" "$TEMP_DIR/"
                    pattern_count["$pattern"]=$((current_count + 1))
                    break
                  fi
                fi
              done
            done
            
          # é»‘åå•æ¨¡å¼
          elif [ -n "$filter_exclude" ]; then
            for file in "$DOWNLOAD_DIR"/*; do
              [ -f "$file" ] || continue
              filename=$(basename "$file")
              
              excluded=false
              for pattern in $filter_exclude; do
                if [[ "$filename" == $pattern ]]; then
                  excluded=true
                  break
                fi
              done
              
              if [ "$excluded" = false ]; then
                cp "$file" "$TEMP_DIR/"
              fi
            done
          fi
          
          file_count=$(ls -1 "$TEMP_DIR" 2>/dev/null | wc -l)
          echo "ðŸ“Š è¿‡æ»¤åŽ: $file_count ä¸ªæ–‡ä»¶"
          
          if [ "$file_count" -eq 0 ]; then
            echo "âš ï¸  è¿‡æ»¤åŽæ— æ–‡ä»¶"
            echo "downloaded=false" >> $GITHUB_ENV
          else
            rm -rf "$DOWNLOAD_DIR"
            mv "$TEMP_DIR" "$DOWNLOAD_DIR"
            echo "âœ… è¿‡æ»¤å®Œæˆ"
          fi

      - name: ðŸš€ å¹¶è¡Œå‘å¸ƒåˆ° GitCode å’Œ Gitee
        if: env.downloaded == 'true'
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITCODE_USERNAME: ${{ secrets.GITCODE_USERNAME || 'whzhni' }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME || 'whzhni' }}
        run: |
          local_name="${{ steps.set-names.outputs.local_name }}"
          version="${{ steps.get-version.outputs.version }}"
          github_owner="${{ matrix.github_owner }}"
          github_repo="${{ matrix.github_repo }}"
          
          BUILD_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          
          RELEASE_BODY="## ðŸ“¦ ${local_name} ${version}

          ### ðŸ“Œ é¡¹ç›®ä¿¡æ¯
          - é¡¹ç›®åç§°: ${github_repo}
          - é¡¹ç›®ç‰ˆæœ¬: ${version}
          - ä¸Šæ¸¸ä»“åº“: https://github.com/${github_owner}/${github_repo}
          - ä¸Šæ¸¸åœ°å€: https://github.com/${github_owner}/${github_repo}/releases/tag/${version#v}

          ### ðŸ”¨ åŒæ­¥ä¿¡æ¯
          - åŒæ­¥æ—¶é—´: ${BUILD_TIME} (åŒ—äº¬æ—¶é—´)
          - å·¥ä½œæµè¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          UPLOAD_FILES=$(find "${{ env.DOWNLOAD_DIR }}" -type f | tr '\n' ' ')
          
          echo "å‡†å¤‡å¹¶è¡Œå‘å¸ƒ"
          echo "ä»“åº“å: $local_name"
          echo "ç‰ˆæœ¬: $version"
          echo "æ–‡ä»¶æ•°: $(echo $UPLOAD_FILES | wc -w)"
          
          # å¹¶è¡Œå‘å¸ƒ
          (
            GITCODE_TOKEN="$GITCODE_TOKEN" \
            USERNAME="$GITCODE_USERNAME" \
            REPO_NAME="$local_name" \
            TAG_NAME="$version" \
            RELEASE_TITLE="$local_name $version" \
            RELEASE_BODY="$RELEASE_BODY" \
            UPLOAD_FILES="$UPLOAD_FILES" \
            RUNNER_TEMP="${{ runner.temp }}" \
            .github/workflows/scripts/release-GitCode.sh
          ) &
          GITCODE_PID=$!
          
          (
            GITEE_TOKEN="$GITEE_TOKEN" \
            USERNAME="$GITEE_USERNAME" \
            REPO_NAME="$local_name" \
            TAG_NAME="$version" \
            RELEASE_TITLE="$local_name $version" \
            RELEASE_BODY="$RELEASE_BODY" \
            UPLOAD_FILES="$UPLOAD_FILES" \
            RUNNER_TEMP="${{ runner.temp }}" \
            .github/workflows/scripts/release-gitee.sh
          ) &
          GITEE_PID=$!
          
          wait $GITCODE_PID
          GITCODE_STATUS=$?
          
          wait $GITEE_PID
          GITEE_STATUS=$?
          
          echo ""
          echo "ðŸ“Š å‘å¸ƒç»“æžœ"
          echo "GitCode: $([ $GITCODE_STATUS -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
          echo "Gitee:   $([ $GITEE_STATUS -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
          
          if [ $GITCODE_STATUS -eq 0 ] || [ $GITEE_STATUS -eq 0 ]; then
            echo "release_success=true" >> $GITHUB_ENV
          else
            echo "::error::ä¸¤ä¸ªå¹³å°éƒ½å‘å¸ƒå¤±è´¥"
            exit 1
          fi

      - name: æ›´æ–°ç‰ˆæœ¬è®°å½•
        if: env.release_success == 'true'
        run: |
          local_name="${{ steps.set-names.outputs.local_name }}"
          version="${{ steps.get-version.outputs.version }}"
          
          .github/workflows/scripts/version-manager.sh write "$local_name" "$version"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add version.txt
          
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ“ æ›´æ–°ç‰ˆæœ¬: $local_name â†’ $version"
            git pull --rebase origin ${{ github.ref_name }} || true
            git push origin ${{ github.ref_name }}
            echo "âœ… ç‰ˆæœ¬è®°å½•å·²æ›´æ–°"
          else
            echo "â„¹ï¸  ç‰ˆæœ¬è®°å½•æ— å˜åŒ–"
          fi
          
      - name: ç”ŸæˆçŠ¶æ€ä¿¡æ¯
        if: always()
        run: |
          github_repo="${{ matrix.github_repo }}"
          local_name="${{ steps.set-names.outputs.local_name }}"
          version="${{ steps.get-version.outputs.version }}"
          local_version="${{ steps.check-update.outputs.local_version }}"
          
          mkdir -p /tmp/status
          
          if [ "${{ steps.get-version.outputs.has_release }}" != "true" ]; then
            status="æœªæ‰¾åˆ° Release"
            upstream_ver="-"
            local_ver="-"
          elif [ "${{ steps.check-update.outputs.needs_update }}" != "true" ]; then
            status="âœ… æ— éœ€æ›´æ–°"
            upstream_ver="${version}"
            local_ver="${version}"
          elif [ "${{ env.release_success }}" == "true" ]; then
            status="âœ… å·²å‘å¸ƒ"
            upstream_ver="${version}"
            local_ver="${local_version}"
          else
            status="âŒ å¤±è´¥"
            upstream_ver="${version:-"-"}"
            local_ver="${local_version:-"-"}"
          fi
          
          echo "${github_repo}" > "/tmp/status/${github_repo}.txt"
          echo "${local_name}" >> "/tmp/status/${github_repo}.txt"
          echo "${upstream_ver}" >> "/tmp/status/${github_repo}.txt"
          echo "${local_ver}" >> "/tmp/status/${github_repo}.txt"
          echo "${status}" >> "/tmp/status/${github_repo}.txt"
          
      - name: ä¸Šä¼ çŠ¶æ€
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: status-${{ matrix.github_repo }}
          path: /tmp/status/${{ matrix.github_repo }}.txt
          retention-days: 1
          
  summary:
    name: ç”ŸæˆåŒæ­¥æŠ¥å‘Š
    needs: sync
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ä¸‹è½½çŠ¶æ€ä¿¡æ¯
        uses: actions/download-artifact@v4
        with:
          pattern: status-*
          path: /tmp/artifacts
          merge-multiple: false
          
      - name: ç”ŸæˆæŠ¥å‘Š
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ“‹ ä¸Šæ¸¸åŒæ­¥æŠ¥å‘Š
          
          **æ‰§è¡Œæ—¶é—´:** $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)
          
          ## ðŸ“Š åŒæ­¥è¯¦æƒ…
          
          | ä¸Šæ¸¸é¡¹ç›® | ä»“åº“åç§° | ä¸Šæ¸¸ç‰ˆæœ¬ | æœ¬åœ°ç‰ˆæœ¬ | çŠ¶æ€ |
          |----------|----------|----------|----------|------|
          EOF
          
          total=0
          updated=0
          skipped=0
          failed=0
          
          for artifact_dir in /tmp/artifacts/status-*/; do
            if [ -d "$artifact_dir" ]; then
              for status_file in "$artifact_dir"*.txt; do
                if [ -f "$status_file" ]; then
                  github_repo=$(sed -n '1p' "$status_file" | tr -d '\r')
                  local_name=$(sed -n '2p' "$status_file" | tr -d '\r')
                  upstream_ver=$(sed -n '3p' "$status_file" | tr -d '\r')
                  local_ver=$(sed -n '4p' "$status_file" | tr -d '\r')
                  status=$(sed -n '5p' "$status_file" | tr -d '\r')
                  
                  total=$((total + 1))
                  case "$status" in
                    *"å·²å‘å¸ƒ"*) updated=$((updated + 1)) ;;
                    *"æ— éœ€æ›´æ–°"*) skipped=$((skipped + 1)) ;;
                    *"å¤±è´¥"*) failed=$((failed + 1)) ;;
                  esac
                  
                  echo "| $github_repo | $local_name | $upstream_ver | $local_ver | $status |" >> $GITHUB_STEP_SUMMARY
                fi
              done
            fi
          done
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ---
          
          **ç»Ÿè®¡:** æ€»è®¡ $total ä¸ªé¡¹ç›® | å·²å‘å¸ƒ $updated ä¸ª | æ— éœ€æ›´æ–° $skipped ä¸ª | å¤±è´¥ $failed ä¸ª
          
          **å‘å¸ƒå¹³å°:**
          - ðŸŒ GitCode
          - ðŸŒ Gitee
          EOF
          
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        uses: geekyeggo/delete-artifact@v5
        with:
          name: status-*
          failOnError: false
