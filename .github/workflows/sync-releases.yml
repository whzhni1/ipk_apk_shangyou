name: åŒæ­¥ä¸Šæ¸¸å‘å¸ƒç‰ˆæœ¬

on:
  schedule:
    - cron: '0 19 * * *'  # åŒ—äº¬æ—¶é—´ 3:00 AM = UTC 19:00
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    name: åŒæ­¥ ${{ matrix.github_repo }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # ===================================
          # ä¸Šæ¸¸ä»“åº“é…ç½® - åœ¨æ­¤æ·»åŠ æˆ–ä¿®æ”¹ä»“åº“
          # ===================================
          
          # OpenClashï¼ˆæ˜ å°„åç§°ï¼‰
          - github_owner: "vernesong"
            github_repo: "OpenClash"
            local_name: "luci-app-OpenClash"
            
          # luci-app-tailscaleï¼ˆæ˜ å°„åç§°ï¼‰
          - github_owner: "whzhni1"
            github_repo: "luci-app-tailscale"
            local_name: "tailscale"
            
          # luci-app-luckyï¼ˆæ˜ å°„åç§° + è¿‡æ»¤è§„åˆ™ï¼‰
          - github_owner: "gdy666"
            github_repo: "luci-app-lucky"
            local_name: "lucky"
            filter_include: "luci-app-*:1 luci-i18n-*:1 *wanji*"  # :1 è¡¨ç¤ºåªä¿ç•™1ä¸ª
            
          # luci-theme-auroraï¼ˆä¿æŒåŸåï¼‰
          - github_owner: "eamonxg"
            github_repo: "luci-theme-aurora"
            
          # openwrt-passwallï¼ˆæ˜ å°„åç§° + æ’é™¤è§„åˆ™ï¼‰
          - github_owner: "xiaorouji"
            github_repo: "openwrt-passwall"
            local_name: "luci-app-passwall"
            filter_exclude: "luci-19.07* *.zip"
            
          # openwrt-passwall2ï¼ˆæ˜ å°„åç§° + æ’é™¤è§„åˆ™ï¼‰
          - github_owner: "xiaorouji"
            github_repo: "openwrt-passwall2"
            local_name: "luci-app-passwall2"
            filter_exclude: "luci-19.07* *.zip"
            
          # é…ç½®è¯´æ˜ï¼š
          # - github_owner: "ä½œè€…å"                    # å¿…å¡«
          # - github_repo: "é¡¹ç›®å"                      # å¿…å¡«  
          # - local_name: "æœ¬åœ°æ–‡ä»¶å¤¹å"                # å¯é€‰ï¼Œä¸è®¾ç½®åˆ™ä½¿ç”¨ github_repo
          # - filter_exclude: "*.zip *.rar"            # å¯é€‰ï¼Œæ’é™¤åŒ¹é…çš„æ–‡ä»¶ï¼ˆç©ºæ ¼åˆ†éš”å¤šä¸ªæ¨¡å¼ï¼‰
          # - filter_include: "*.ipk *zh-cn*"          # å¯é€‰ï¼Œåªä¿ç•™åŒ¹é…çš„æ–‡ä»¶
          # - filter_include: "luci-app-*:1"           # :1 è¡¨ç¤ºè¯¥æ¨¡å¼åªä¿ç•™ç¬¬1ä¸ªåŒ¹é…çš„æ–‡ä»¶
          
      fail-fast: false
      max-parallel: 3
      
    steps:
      - name: æ£€å‡ºç›®æ ‡ä»“åº“
        uses: actions/checkout@v3
        with:
          repository: whzhni1/ipk_apk  # ç›®æ ‡ä»“åº“
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨ PAT Token
          
      - name: é…ç½® Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          
      - name: è®¾ç½®æœ¬åœ°åç§°
        id: set-names
        run: |
          local_name="${{ matrix.local_name }}"
          if [ -z "$local_name" ]; then
            local_name="${{ matrix.github_repo }}"
          fi
          
          echo "local_name=$local_name" >> $GITHUB_OUTPUT
          echo "ğŸ“ ä¸Šæ¸¸: ${{ matrix.github_repo }}"
          echo "ğŸ“‚ æœ¬åœ°: $local_name"
          
      - name: ä» Tags è·å–æœ€æ–°ç‰ˆæœ¬
        id: get-version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          github_owner="${{ matrix.github_owner }}"
          github_repo="${{ matrix.github_repo }}"
          full_repo="${github_owner}/${github_repo}"
          
          echo "========================================="
          echo "ğŸ“¦ é¡¹ç›®: $github_repo"
          echo "ğŸ‘¤ ä½œè€…: $github_owner"
          echo "========================================="
          
          echo "ğŸ“Œ è·å–æœ€æ–° Tag..."
          tags_response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$full_repo/tags?per_page=1")
          
          if echo "$tags_response" | jq -e '.[0]' > /dev/null 2>&1; then
            latest_tag=$(echo "$tags_response" | jq -r '.[0].name')
            echo "ğŸ†• æœ€æ–° Tag: $latest_tag"
          else
            echo "âŒ æœªæ‰¾åˆ° Tag"
            echo "has_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ "$latest_tag" = "null" ] || [ -z "$latest_tag" ]; then
            echo "âŒ æ— æ³•è·å– Tag"
            echo "has_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ“¥ è·å– Release..."
          release_response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$full_repo/releases/tags/$latest_tag")
          
          if echo "$release_response" | jq -e '.assets' > /dev/null 2>&1; then
            echo "âœ… æ‰¾åˆ° Release"
            echo "$release_response" > /tmp/release.json
            echo "has_release=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  å°è¯•æœ€æ–° Release..."
            latest_release=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$full_repo/releases/latest")
            
            if echo "$latest_release" | jq -e '.assets' > /dev/null 2>&1; then
              release_tag=$(echo "$latest_release" | jq -r '.tag_name')
              echo "âœ… ä½¿ç”¨: $release_tag"
              latest_tag="$release_tag"
              echo "$latest_release" > /tmp/release.json
              echo "has_release=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ æœªæ‰¾åˆ° Release"
              echo "has_release=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # ä¿å­˜åŸå§‹ç‰ˆæœ¬å·
          echo "raw_version=$latest_tag" >> $GITHUB_OUTPUT
          
          # è§„èŒƒåŒ–ç‰ˆæœ¬å·ï¼ˆç¡®ä¿æœ‰ v å‰ç¼€ï¼‰
          if [[ "$latest_tag" =~ ^v ]]; then
            # å·²ç»æœ‰ v å‰ç¼€
            normalized_version="$latest_tag"
            echo "ğŸ“Œ ç‰ˆæœ¬æ ¼å¼: å·²è§„èŒƒ ($normalized_version)"
          else
            # æ²¡æœ‰ v å‰ç¼€ï¼Œæ·»åŠ 
            normalized_version="v$latest_tag"
            echo "ğŸ“Œ ç‰ˆæœ¬æ ¼å¼: è§„èŒƒåŒ– ($latest_tag â†’ $normalized_version)"
          fi
          
          echo "version=$normalized_version" >> $GITHUB_OUTPUT
          
      - name: æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬
        id: check-local
        if: steps.get-version.outputs.has_release == 'true'
        run: |
          local_name="${{ steps.set-names.outputs.local_name }}"
          latest_version="${{ steps.get-version.outputs.version }}"
          
          echo "ğŸ” æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬..."
          
          if [ ! -d "$local_name" ]; then
            echo "ğŸ“ åˆ›å»ºç›®å½•: $local_name"
            mkdir -p "$local_name"
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "is_new=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥ç‰ˆæœ¬ï¼ˆä½¿ç”¨è§„èŒƒåŒ–åçš„ç‰ˆæœ¬å·ï¼‰
          if [ -d "$local_name/$latest_version" ]; then
            echo "âœ… å·²å­˜åœ¨: $latest_version"
            echo "needs_update=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # è·å–æœ¬åœ°ç‰ˆæœ¬ï¼ˆåº”è¯¥éƒ½æ˜¯ v å¼€å¤´çš„ï¼‰
          local_versions=$(ls -1 "$local_name" 2>/dev/null | grep -v "^\." || true)
          if [ -n "$local_versions" ]; then
            local_version=$(echo "$local_versions" | head -n 1)
            echo "ğŸ“Œ å½“å‰: $local_version"
            echo "local_version=$local_version" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ”„ æ–°ç‰ˆæœ¬: $latest_version"
          echo "needs_update=true" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½æ–‡ä»¶
        if: steps.check-local.outputs.needs_update == 'true'
        run: |
          local_name="${{ steps.set-names.outputs.local_name }}"
          latest_version="${{ steps.get-version.outputs.version }}"
          local_version="${{ steps.check-local.outputs.local_version }}"
          is_new="${{ steps.check-local.outputs.is_new }}"
          
          if [ -n "$local_version" ] && [ "$is_new" != "true" ]; then
            echo "ğŸ—‘ï¸  åˆ é™¤æ—§ç‰ˆæœ¬"
            rm -rf "$local_name"/*
          fi
          
          target_dir="$local_name/$latest_version"
          mkdir -p "$target_dir"
          echo "ğŸ“‚ åˆ›å»º: $target_dir"
          
          latest_release=$(cat /tmp/release.json)
          download_count=$(echo "$latest_release" | jq '.assets | length')
          
          if [ "$download_count" -eq 0 ]; then
            echo "âš ï¸  æ— é™„ä»¶"
            echo "downloaded=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "ğŸ“¥ ä¸‹è½½ $download_count ä¸ªæ–‡ä»¶"
          
          echo "$latest_release" | jq -r '.assets[] | "\(.browser_download_url)|\(.name)"' | while IFS='|' read -r url filename; do
            if [ -n "$url" ] && [ -n "$filename" ]; then
              if curl -L -f --max-time 300 -o "$target_dir/$filename" "$url" 2>/dev/null; then
                size=$(ls -lh "$target_dir/$filename" | awk '{print $5}')
                echo "âœ… $filename ($size)"
              else
                echo "âŒ $filename"
              fi
            fi
          done
          
          file_count=$(find "$target_dir" -type f 2>/dev/null | wc -l)
          
          echo ""
          echo "ğŸ“Š å®Œæˆ: $file_count ä¸ªæ–‡ä»¶"
          
          if [ "$file_count" -eq 0 ]; then
            echo "âŒ ä¸‹è½½å¤±è´¥"
            rm -rf "$target_dir"
            [ -z "$(ls -A "$local_name" 2>/dev/null)" ] && rm -rf "$local_name"
            echo "downloaded=false" >> $GITHUB_ENV
            exit 1
          fi
          
          echo "downloaded=true" >> $GITHUB_ENV
          
      - name: åº”ç”¨è¿‡æ»¤è§„åˆ™
        if: env.downloaded == 'true' && (matrix.filter_exclude != '' || matrix.filter_include != '')
        run: |
          local_name="${{ steps.set-names.outputs.local_name }}"
          latest_version="${{ steps.get-version.outputs.version }}"
          raw_version="${{ steps.get-version.outputs.raw_version }}"
          filter_exclude="${{ matrix.filter_exclude }}"
          filter_include="${{ matrix.filter_include }}"
          
          WORK_DIR="$(pwd)"
          TARGET_DIR="$WORK_DIR/$local_name/$latest_version"
          TEMP_DIR="$WORK_DIR/$local_name/.filter_temp"
          
          # è·å–ä¸å¸¦ v çš„ç‰ˆæœ¬å·ï¼ˆç”¨äºæ–‡ä»¶ååŒ¹é…ï¼‰
          VERSION_NO_V=${latest_version#v}
          
          echo "========================================="
          echo "ğŸ§¹ åº”ç”¨è¿‡æ»¤è§„åˆ™"
          echo "========================================="
          echo "è§„èŒƒåŒ–ç‰ˆæœ¬: $latest_version"
          echo "åŒ¹é…ç‰ˆæœ¬: $VERSION_NO_V (ç”¨äºæ–‡ä»¶ååŒ¹é…)"
          
          # æ˜¾ç¤ºè§„åˆ™
          [ -n "$filter_exclude" ] && echo "æ’é™¤: $filter_exclude"
          [ -n "$filter_include" ] && echo "ä¿ç•™: $filter_include"
          echo ""
          
          rm -rf "$TEMP_DIR"
          mkdir -p "$TEMP_DIR"
          
          # å¦‚æœæœ‰ include è§„åˆ™ï¼Œä½¿ç”¨ç™½åå•æ¨¡å¼
          if [ -n "$filter_include" ]; then
            echo "ğŸ“‹ ç™½åå•æ¨¡å¼ï¼ˆåªä¿ç•™åŒ¹é…é¡¹ï¼‰"
            
            # è§£æ include è§„åˆ™ï¼Œæ”¯æŒ :1 é™åˆ¶æ•°é‡
            declare -A pattern_count
            declare -A pattern_limit
            
            for pattern_rule in $filter_include; do
              # æ£€æŸ¥æ˜¯å¦æœ‰æ•°é‡é™åˆ¶ï¼ˆå¦‚ luci-app-*:1ï¼‰
              if [[ "$pattern_rule" == *:* ]]; then
                pattern="${pattern_rule%:*}"
                limit="${pattern_rule#*:}"
                
                # æ›¿æ¢ç‰ˆæœ¬å·å˜é‡
                pattern="${pattern//\{VERSION\}/$VERSION_NO_V}"
                
                pattern_limit["$pattern"]=$limit
                pattern_count["$pattern"]=0
              else
                pattern="$pattern_rule"
                
                # æ›¿æ¢ç‰ˆæœ¬å·å˜é‡
                pattern="${pattern//\{VERSION\}/$VERSION_NO_V}"
                
                pattern_limit["$pattern"]=999999
                pattern_count["$pattern"]=0
              fi
            done
            
            # éå†æ–‡ä»¶
            for file in "$TARGET_DIR"/*; do
              [ -f "$file" ] || continue
              filename=$(basename "$file")
              
              # æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½• include æ¨¡å¼
              matched=false
              for pattern in "${!pattern_limit[@]}"; do
                if [[ "$filename" == $pattern ]]; then
                  current_count=${pattern_count["$pattern"]}
                  limit=${pattern_limit["$pattern"]}
                  
                  if [ $current_count -lt $limit ]; then
                    cp "$file" "$TEMP_DIR/"
                    pattern_count["$pattern"]=$((current_count + 1))
                    matched=true
                    break
                  fi
                fi
              done
            done
            
          # å¦‚æœåªæœ‰ exclude è§„åˆ™ï¼Œä½¿ç”¨é»‘åå•æ¨¡å¼
          elif [ -n "$filter_exclude" ]; then
            echo "ğŸ“‹ é»‘åå•æ¨¡å¼ï¼ˆæ’é™¤åŒ¹é…é¡¹ï¼‰"
            
            for file in "$TARGET_DIR"/*; do
              [ -f "$file" ] || continue
              filename=$(basename "$file")
              
              # æ£€æŸ¥æ˜¯å¦åŒ¹é…ä»»ä½• exclude æ¨¡å¼
              excluded=false
              for pattern in $filter_exclude; do
                if [[ "$filename" == $pattern ]]; then
                  excluded=true
                  break
                fi
              done
              
              # ä¸åŒ¹é…æ’é™¤è§„åˆ™çš„æ–‡ä»¶ä¿ç•™
              if [ "$excluded" = false ]; then
                cp "$file" "$TEMP_DIR/"
              fi
            done
          fi
          
          # ç»Ÿè®¡ç»“æœ
          file_count=$(ls -1 "$TEMP_DIR" 2>/dev/null | wc -l)
          
          echo "ğŸ“Š è¿‡æ»¤ç»“æœ: $file_count ä¸ªæ–‡ä»¶"
          
          if [ "$file_count" -eq 0 ]; then
            echo "âš ï¸  è¿‡æ»¤åæ— æ–‡ä»¶"
            rm -rf "$TEMP_DIR" "$TARGET_DIR"
            [ -z "$(ls -A "$WORK_DIR/$local_name" 2>/dev/null)" ] && rm -rf "$WORK_DIR/$local_name"
            echo "downloaded=false" >> $GITHUB_ENV
          else
            rm -rf "$TARGET_DIR"
            mv "$TEMP_DIR" "$TARGET_DIR"
            echo "âœ… è¿‡æ»¤å®Œæˆ"
          fi
          
      - name: æäº¤å¹¶æ¨é€åˆ°ç›®æ ‡ä»“åº“
        if: env.downloaded == 'true'
        run: |
          github_owner="${{ matrix.github_owner }}"
          github_repo="${{ matrix.github_repo }}"
          local_name="${{ steps.set-names.outputs.local_name }}"
          latest_version="${{ steps.get-version.outputs.version }}"
          
          git add "$local_name"
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ— éœ€æäº¤"
            exit 0
          fi
          
          git commit -m "ğŸš€ æ›´æ–° $github_repo åˆ°ç‰ˆæœ¬ $latest_version
          
          - ä¸Šæ¸¸é¡¹ç›®: $github_repo
          - æœ¬åœ°ç›®å½•: $local_name
          - ç‰ˆæœ¬å·: $latest_version
          - ä¸Šæ¸¸ä»“åº“: $github_owner/$github_repo
          - æ›´æ–°æ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)"
          
          max_retries=5
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if git push; then
              echo "âœ… æ¨é€æˆåŠŸåˆ° whzhni1/ipk_apk"
              break
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "âš ï¸  é‡è¯• $retry_count/$max_retries"
                sleep $((retry_count * 5))
                git pull --rebase --autostash
              else
                echo "âŒ æ¨é€å¤±è´¥"
                exit 1
              fi
            fi
          done
  
      - name: è¾“å‡ºç»“æœ
        if: always()
        run: |
          github_repo="${{ matrix.github_repo }}"
          local_name="${{ steps.set-names.outputs.local_name }}"
          latest_version="${{ steps.get-version.outputs.version }}"
          local_version="${{ steps.check-local.outputs.local_version }}"
          
          # åˆ›å»ºçŠ¶æ€æ–‡ä»¶
          mkdir -p /tmp/status
          
          # ç¡®å®šçŠ¶æ€
          if [ "${{ steps.get-version.outputs.has_release }}" != "true" ]; then
            status="æœªæ‰¾åˆ°"
            upstream_ver="-"
            local_ver="-"
          elif [ "${{ steps.check-local.outputs.needs_update }}" != "true" ]; then
            status="æ— éœ€æ›´æ–°"
            upstream_ver="${latest_version}"
            local_ver="${latest_version}"
          elif [ "${{ env.downloaded }}" == "true" ]; then
            status="âœ… å·²æ›´æ–°"
            upstream_ver="${latest_version}"
            local_ver="${local_version:-æ–°å»º}"
          else
            status="âŒ å¤±è´¥"
            upstream_ver="${latest_version:-"-"}"
            local_ver="${local_version:-"-"}"
          fi
          
          # å†™å…¥çŠ¶æ€æ–‡ä»¶ï¼ˆé€è¡Œå†™å…¥ï¼Œé¿å… heredoc é—®é¢˜ï¼‰
          echo "${github_repo}" > "/tmp/status/${github_repo}.txt"
          echo "${local_name}" >> "/tmp/status/${github_repo}.txt"
          echo "${upstream_ver}" >> "/tmp/status/${github_repo}.txt"
          echo "${local_ver}" >> "/tmp/status/${github_repo}.txt"
          echo "${status}" >> "/tmp/status/${github_repo}.txt"
          
          echo ""
          echo "========================================="
          echo "ğŸ“‹ $github_repo: $status"
          [ "$local_name" != "$github_repo" ] && echo "   â†’ $local_name"
          echo "   ä¸Šæ¸¸ç‰ˆæœ¬: $upstream_ver"
          echo "   æœ¬åœ°ç‰ˆæœ¬: $local_ver"
          echo "   ç›®æ ‡ä»“åº“: whzhni1/ipk_apk"
          echo "========================================="
          
      - name: ä¸Šä¼ çŠ¶æ€ä¿¡æ¯
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: status-${{ matrix.github_repo }}
          path: /tmp/status/${{ matrix.github_repo }}.txt
          retention-days: 1
          
  summary:
    name: ç”ŸæˆåŒæ­¥æŠ¥å‘Š
    needs: sync
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ä¸‹è½½æ‰€æœ‰çŠ¶æ€ä¿¡æ¯
        uses: actions/download-artifact@v4
        with:
          pattern: status-*
          path: /tmp/artifacts
          merge-multiple: false
          
      - name: ç”ŸæˆæŠ¥å‘Š
        run: |
          echo "# ğŸ“‹ åŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç›®æ ‡ä»“åº“:** whzhni1/ipk_apk" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´:** $(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S') (åŒ—äº¬æ—¶é—´)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.sync.result }}" == "success" ]; then
            echo "**çŠ¶æ€:** âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.sync.result }}" == "failure" ]; then
            echo "**çŠ¶æ€:** âš ï¸ éƒ¨åˆ†ä»»åŠ¡å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          else
            echo "**çŠ¶æ€:** â„¹ï¸ ä»»åŠ¡æ‰§è¡Œå®Œæ¯•" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š åŒæ­¥è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›®åç§° | æœ¬åœ°ç›®å½• | ä¸Šæ¸¸ç‰ˆæœ¬ | æœ¬åœ°ç‰ˆæœ¬ | æ›´æ–°æƒ…å†µ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|----------|----------|----------|" >> $GITHUB_STEP_SUMMARY
          
          total_count=0
          updated_count=0
          skipped_count=0
          failed_count=0
          
          for artifact_dir in /tmp/artifacts/status-*/; do
            if [ -d "$artifact_dir" ]; then
              for status_file in "$artifact_dir"*.txt; do
                if [ -f "$status_file" ]; then
                  github_repo=$(sed -n '1p' "$status_file" | tr -d '\r')
                  local_name=$(sed -n '2p' "$status_file" | tr -d '\r')
                  upstream_ver=$(sed -n '3p' "$status_file" | tr -d '\r')
                  local_ver=$(sed -n '4p' "$status_file" | tr -d '\r')
                  status=$(sed -n '5p' "$status_file" | tr -d '\r')
                  
                  total_count=$((total_count + 1))
                  case "$status" in
                    *"å·²æ›´æ–°"*) updated_count=$((updated_count + 1)) ;;
                    *"æ— éœ€æ›´æ–°"*) skipped_count=$((skipped_count + 1)) ;;
                    *"å¤±è´¥"*) failed_count=$((failed_count + 1)) ;;
                  esac
                  
                  echo "| $github_repo | $local_name | $upstream_ver | $local_ver | $status |" >> $GITHUB_STEP_SUMMARY
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç»Ÿè®¡:** æ€»è®¡ $total_count ä¸ªé¡¹ç›®ï¼Œå·²æ›´æ–° $updated_count ä¸ªï¼Œæ— éœ€æ›´æ–° $skipped_count ä¸ªï¼Œå¤±è´¥ $failed_count ä¸ª" >> $GITHUB_STEP_SUMMARY
          
      - name: æ¸…ç†ä¸´æ—¶ Artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v5
        with:
          name: status-*
          failOnError: false
